#!/bin/bash

export CARGO_TERM_COLOR="always"

function main {
	local mode
	local package
	local profile
	local toolchain
	local -a extra_args
	while [[ "$#" != 0 ]]; do
		local arg="$1"; shift
		case "$arg" in
			(year-*) year="${arg:5}" ;;
			(day-*) day="${arg:4}" ;;
			(coverage|dev|release|release-lto) profile="$arg" ;;
			(build|clippy|flamegraph|fuzz|run|run-test|tarpaulin|test) mode="$arg" ;;
			(cmin|repr) fuzz_mode="$arg" ;;
			(part-1|part-2) run_args+=( "$arg" ) ;;
			(nightly) toolchain="+$arg" ;;
			(--profile) profile="$1"; shift ;;
			(--width) flamegraph_width="$1"; shift ;;
			(--) extra_args=( "$@" ); shift $# ;;
			(*) echo "Unknown command: $arg" >&2; exit 1 ;;
		esac
	done
	if [[ -n "$year" && -n "$day" ]]; then
		package="aoc-$year-day-$day"
	elif [[ -n "$year" ]]; then
		package="aoc-$year"
	fi
	local -a cargo_args
	if [[ -z "$mode" ]]; then mode="build"; fi
	if [[ -z "$profile" && "$mode" = "flamegraph" ]]; then profile="flamegraph"; fi
	if [[ -n "$package" ]]; then cargo_args+=( --package "$package" ); fi
	if [[ -n "$profile" ]]; then cargo_args+=( --profile "$profile" ); fi
	case "$mode" in
		(build)
			time env time -v cargo $toolchain build "${extra_args[@]}"
			;;
		(clippy)
			local -a clippy_args=( $(cat "$(dirname "$0")"/clippy-args) )
			echo cargo $toolchain clippy "${cargo_args[@]}" -- "${clippy_args[@]}"
			cargo $toolchain clippy "${cargo_args[@]}" -- "${clippy_args[@]}"
			;;
		(fuzz)
			cd fuzz
			if [[ -z "$fuzz_mode" ]]; then fuzz_mode="run"; fi
			case "$fuzz_mode" in
				(run|cmin)
					cargo +nightly fuzz "$fuzz_mode" "$year-day-$day" "corpus/$year-day-$day" "${extra_args[@]}"
					;;
				(repr)
					cargo +nightly fuzz run "$year-day-$day" "${extra_args[@]}"
					;;
				(*)
					echo "Syntax error" >&2
					exit 1
					;;
			esac
			;;
		(run-test)
			time env time -v cargo $toolchain run "${cargo_args[@]}" -- "${extra_args[@]}"
			time env time -v cargo $toolchain test "${cargo_args[@]}"
			;;
		(run)
			time env time -v cargo $toolchain run "${cargo_args[@]}" -- "${extra_args[@]}"
			;;
		(test)
			time env time -v cargo $toolchain test "${cargo_args[@]}" -- "${extra_args[@]}"
			;;
		(flamegraph)
			cargo_args+=( --image-width "${flamegraph_width:-4000}" )
			cargo_args+=( --palette "rust" )
			local timestamp=$(date +"%Y-%m-%d-%H:%M:%S")
			if cargo $toolchain flamegraph \
				"${cargo_args[@]}" \
				--output target/flamegraph-$timestamp.svg \
				-- \
				"${extra_args[@]}"
			then
				(eog flamegraph.svg target/flamegraph-$timestamp.svg &)
				mv perf.data target/flamegraph-$timestamp.perf-data
				ln -fns flamegraph-$timestamp.svg target/flamegraph-latest.svg
				ln -fns flamegraph-$timestamp.perf-data target/flamegraph-latest.perf-data
			fi
			;;
		(tarpaulin)
			if [[ -z "$profile" ]]; then profile="coverage"; fi
			cargo $toolchain tarpaulin \
				--workspace \
				--out Html \
				--exclude-files "main.rs" \
				--exclude-files "build.rs" \
				--profile "$profile" \
				--output-dir target/tarpaulin
			firefox --new-window "target/tarpaulin/tarpaulin-report.html"
			;;
	esac
}

main "$@"
