#!/bin/bash

export CARGO_TERM_COLOR="always"

declare year="$(basename $PWD)"

function main {
	local mode
	local package
	local profile
	local toolchain
	local -a run_args
	while [[ "$#" != 0 ]]; do
		local arg="$1"; shift
		case "$arg" in
			(day-*) package="aoc-$year-day-${arg:4}" ;;
			(coverage|dev|release|release-lto) profile="$arg" ;;
			(clippy|flamegraph|run|run-test|tarpaulin|test) mode="$arg" ;;
			(part-1|part-2) run_args+=( "$arg" ) ;;
			(nightly) toolchain="+$arg" ;;
			(--profile) profile="$1"; shift ;;
			(--width) flamegraph_width="$1"; shift ;;
			(--)
				case "$mode" in
					(""|run|run-test|flamegraph) run_args+=( "$@" ) ;;
					(test) test_args+=( "$@" ) ;;
				esac
				shift $#
				;;
			(*)
				echo "Unknown command: $arg"
				exit 1
				;;
		esac
	done
	local -a cargo_args
	if [[ -z "$mode" ]]; then mode="build"; fi
	if [[ -z "$profile" && "$mode" = "flamegraph" ]]; then profile="flamegraph"; fi
	if [[ -n "$package" ]]; then cargo_args+=( --package "$package" ); fi
	if [[ -n "$profile" ]]; then cargo_args+=( --profile "$profile" ); fi
	case "$mode" in
		(build)
			time env time -v cargo $toolchain build "${cargo_args[@]}"
			;;
		(clippy)
			local -a clippy_args=( $(cat "$(dirname "$0")"/clippy-args) )
			cargo $toolchain clippy "${cargo_args[@]}" -- "${clippy_args[@]}"
			;;
		(run-test)
			time env time -v cargo $toolchain run "${cargo_args[@]}" -- "${run_args[@]}"
			time env time -v cargo $toolchain test "${cargo_args[@]}" -- "${test_args[@]}"
			;;
		(run)
			time env time -v cargo $toolchain run "${cargo_args[@]}" -- "${run_args[@]}"
			;;
		(test)
			time env time -v cargo $toolchain test "${cargo_args[@]}" -- "${test_args[@]}"
			;;
		(flamegraph)
			cargo_args+=( --image-width "${flamegraph_width:-4000}" )
			cargo_args+=( --palette "rust" )
			local timestamp=$(date +"%Y-%m-%d-%H:%M:%S")
			if cargo $toolchain flamegraph \
				"${cargo_args[@]}" \
				--output target/flamegraph-$timestamp.svg \
				-- \
				"${run_args[@]}"
			then
				(eog flamegraph.svg target/flamegraph-$timestamp.svg &)
				mv perf.data target/flamegraph-$timestamp.perf-data
				ln -fns flamegraph-$timestamp.svg target/flamegraph-latest.svg
				ln -fns flamegraph-$timestamp.perf-data target/flamegraph-latest.perf-data
			fi
			;;
		(tarpaulin)
			if [[ -z "$profile" ]]; then profile="coverage"; fi
			cargo $toolchain tarpaulin \
				--workspace \
				--out Html \
				--exclude-files "main.rs" \
				--exclude-files "build.rs" \
				--profile "$profile" \
				--output-dir target/tarpaulin
			firefox --new-window "target/tarpaulin/tarpaulin-report.html"
			;;
	esac
}

main "$@"
